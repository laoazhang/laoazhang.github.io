<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Creating a Slack Command Bot from Scratch with Node.js & Distribute It &#8211; Laoazhang! Blog</title>
<meta name="description" content="My tutorial on how to build a Slack slash command and Slack OAuth">
<meta name="keywords" content="">

<!-- Twitter cards -->
<meta name="twitter:site"    content="@laoazhang">
<meta name="twitter:creator" content="@laoazhang">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://laoazhang.cn//assets/images/articles/2016/10/slack-httpstatuscats-icons.png">



<meta name="twitter:title"   content="Creating a Slack Command Bot from Scratch with Node.js & Distribute It">



<meta name="twitter:description" content="My tutorial on how to build a Slack slash command and Slack OAuth">


<!-- end of Twitter cards -->

<!-- Web Monetization | Interledger -->
<meta name="monetization" content="$ilp.uphold.com/6NxbkHNq9N84">
<meta name="monetization" content="$twitter.xrptipbot.com/laoazhang" />

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Creating a Slack Command Bot from Scratch with Node.js & Distribute It">
<meta property="og:description" content="My tutorial on how to build a Slack slash command and Slack OAuth">
<meta property="og:url" content="https://laoazhang.cn/blog/2016/10/24/slack-command-bot-nodejs/">
<meta property="og:site_name" content="Laoazhang! Blog">

<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="I-NDFBl5t1P9fqHmRNZhwu8OOHmwW4HADPiOr_r16cE">



<link rel="canonical" href="https://laoazhang.cn/blog/2016/10/24/slack-command-bot-nodejs/">
<link href="https://laoazhang.cn/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">


<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='//fonts.googleapis.com/css?family=Open+Sans:400italic,400,600,700' rel='stylesheet' type='text/css'>

<!-- For all browsers -->
<link rel="stylesheet" href="https://laoazhang.cn/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="https://laoazhang.cn/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://laoazhang.cn/assets/js/vendor/modernizr/modernizr.js"></script>

<!-- Icons -->

<!-- favicon -->
<link rel="shortcut icon" href="https://laoazhang.cn/assets/ico/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://laoazhang.cn/assets/ico/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://laoazhang.cn/assets/ico/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://laoazhang.cn/assets/ico/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://laoazhang.cn/assets/ico/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="article" itemscope itemtype="https://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="https://laoazhang.cn/index.html">Laoazhang.cn</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" itemscope itemtype="https://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="https://laoazhang.cn/about" >About</a></li>
		        
				<li><a href="https://laoazhang.cn/blog" >Archive</a></li>
		        
				<li><a href="https://laoazhang.cn/presentations" >Preso</a></li>
		        
				<li><a href="https://laoazhang.cn/doodles" >Sketch Notes</a></li>
		        
				<li><a href="https://codepen.io/laoazhang" target="_blank">My CodePen</a></li>
		        
		        <li><i class="icon-feed"></i> <a href="https://laoazhang.cn/feed.xml" title="Atom/RSS feed">Feed</a>
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->


<header role="banner">
</header>

<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="https://schema.org/Blog">
  <div class="article-author-side">
  	<img src="https://laoazhang.cn/assets/images/avatar.jpg" class="bio-photo" alt="laoazhang">
    <h3>laoazhang</h3>
<p class="bio">An Open Web advocate and front-end engineer, who loves everything mobile, and writes about HTML5, CSS, JS, UX, tech events, gadgets, etc. She unintentionally got 15min of fame by creating The HTTP Status Cats. Also, the opinions expressed here are solely her own and do not express the views or opinions of my employer.</p>
<a href="https://twitter.com/laoazhang" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>
<a href="https://facebook.com/laoazhang" class="author-social" target="_blank"><i class="icon-facebook"></i> Facebook</a>

<a href="https://linkedin.com/in/laoazhang" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="https://instagram.com/laoazhang" class="author-social" target="_blank"><i class="icon-instagram"></i> Instagram</a>
<a href="https://github.com/laoazhang" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>




        <p class="license">
      
    </p>

  </div>

  <article itemscope itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
    <div class="headline-wrap">
      
      <time datetime="2016-10-24T00:00:00-07:00" itemprop="datePublished"><i class="icon-calendar"></i> October 24, 2016</time>

      
      <h1 itemprop="name">Creating a Slack Command Bot from Scratch with Node.js & Distribute It</h1>
      <h2></h2>
    </div><!--/ .headline-wrap -->

    <div class="article-wrap" itemprop="text">
      <p><img src="/assets/images/articles/2016/10/slack-httpstatuscats-icons.png" alt="Slack HTTP Status Cats icons" /></p>

<p>It was raining on a few weekends ago, instead of binge-watching some Netflix shows I decided to do some small project with the Conversational UI / Chatbot, and wrote the <a href="http://www.girliemac.com/slack-httpstatuscats/">HTTP Status Cats command for Slack</a>! Basically, I made my <a href="http://http.cat">HTTP cats</a> (that gave myself a 15 minutes of fame in 2011) into a slash command for <a href="https://slack.com">Slack</a>, where can simply type <code class="language-plaintext highlighter-rouge">/httpstatus</code> followed by a status code (e.g. <code class="language-plaintext highlighter-rouge">404</code>) on Slack chat and get the status description with the cat pics. </p>

<p><img src="http://www.girliemac.com/slack-httpstatuscats/public/images/slack-httpstatuscats.gif" alt="HTTP Status Cats Slack bot" /></p>

<p>Although I made some positive notes on its developer-friendliness of the <a href="https://api.slack.com">Slack’s API</a> docs in my <a href="https://medium.com/@girlie_mac/developer-experience-matters-8c4dcb8cc80#.j74b4p2iw">Developer Experiences Matters</a> article, I found it a bit confusing when I actually started developing along with the docs, because there are loaded with info and it is hard to find some resources I need. While developing I took notes of each step, so I decided to share how I have created the HTTP Status Cats command.</p>

<p>There are two parts. You can stop after the step 1 if you don’t wish to distribute your bot:</p>

<ol>
  <li>Writing a slash command with Node.js and run it locally only on your team</li>
  <li>Making it installable for public (so you can submit your bot to <a href="https://slack.com/apps">Slack’s App Directory</a> if you want)</li>
</ol>

<p>My step-by-step instruction uses Node.js, so if you’d like to follow the how-to, make sure <a href="https://nodejs.org">Node.js</a> is installed on your machine.</p>

<p><a href="https://github.com/girliemac/slack-httpstatuscats">The source code</a> and the <a href="http://www.girliemac.com/slack-httpstatuscats/">HTTP Status Cats command bot app</a> are both available on GitHub</p>

<h2 id="1-creating-your-private-slash-command">1. Creating Your Private Slash Command</h2>

<p>In Slack’s official term, what you are going to do is called <a href="https://api.slack.com/custom-integrations">Custom Integrations</a>. Before building what they call App, you need this dry-run on your chat room. If you don’t have your own test team account, <a href="https://slack.com/create">create one</a> to get started.</p>

<h3 id="configuring-your-slash-command">Configuring Your Slash Command</h3>

<p>Sign in to your Slack account and choose your command at <a href="https://my.slack.com/services/new/slash-commands">my.slack.com/services/new/slash-commands</a>. In my case, I entered <code class="language-plaintext highlighter-rouge">/httpstatus</code> and hit the <strong>Add Slash Command Integration</strong> button to go to the next page.</p>

<p>You will see the Outgoing payload data with a token etc, but you don’t need to worry about this in this moment. Just go ahead and fill out some of the fields.</p>

<p><img src="/assets/images/articles/2016/10/slack-config-custom-integration.png" alt="Slack config" /></p>

<p>You can skip most of the field for now, but you must enter the (1) Command, (2) URL, and make sure the (3) Method is POST.</p>

<p>Once you enter them correctly, you should see the “Your settings have been saved!” message on top of the screen for a few seconds.</p>

<p>For the <strong>URL</strong>, I am using a temporary URL from <a href="https://ngrok.com/">ngrok</a>, which serves my localhost to a public URL. You can probably just put your localhost URL such as <code class="language-plaintext highlighter-rouge">http://localhost:3000.</code></p>

<h4 id="optional-using-ngrok">Optional: Using ngrok</h4>

<p>If you wish to use ngrok for your development too, download ngrok from https://ngrok.com, run it on terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ngrok http 3000
</code></pre></div></div>

<p><img src="/assets/images/articles/2016/10/ngrok.png" alt="ngrok" /></p>

<p>Now you’ve got a ngrok URLs for your local server. In this case, localhost:3000. In this case, copy this URL, http://71f03962.ngrok.io and paste it into the configuration setup.</p>

<h3 id="writing-the-response-with-nodejs">Writing the Response with Node.js</h3>

<p>How it works is that when a user trigger the slash command from Slack client’s interface, the message will be sent to the URL via <code class="language-plaintext highlighter-rouge">HTTP POST</code> (or <code class="language-plaintext highlighter-rouge">GET</code> if you specified in your config).</p>

<p>When you receive a request from your user, for instance, <code class="language-plaintext highlighter-rouge">/httpstatus 302</code>, the data that will be posted to your URL looks like:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">command</span><span class="o">=</span>/httpstatus
<span class="nv">text</span><span class="o">=</span>302
<span class="nv">response_url</span><span class="o">=</span>https://hooks.slack.com/commands/1234/5678
...
</code></pre></div></div>

<p>Your bot gives a response for the command, <code class="language-plaintext highlighter-rouge">/httpstatus 302</code> with an answer. In this case the bot will answer with the description of status code 302 with [a cat picture](https://http.cat/302.</p>

<p>Now. let’s write the response with Node.js using Express.</p>

<p>First, install Express.JS and body-parser (for POST):</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>express body-parser <span class="nt">--save</span>
</code></pre></div></div>

<p>Create a <strong>index .js</strong> file, and instantiate express and listen the server to port 3000. Because you have set your ngrok to <code class="language-plaintext highlighter-rouge">localhost:3000</code>, you must use the same port!</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="dl">'</span><span class="s1">use strict</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">express</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">bodyParser</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">body-parser</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nf">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nf">json</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nf">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nf">urlencoded</span><span class="p">({</span> <span class="na">extended</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}));</span>

<span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nf">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="err"> </span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Express server listening on port %d in %s mode</span><span class="dl">'</span><span class="p">,</span> <span class="nx">server</span><span class="p">.</span><span class="nf">address</span><span class="p">().</span><span class="nx">port</span><span class="p">,</span> <span class="nx">app</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">env</span><span class="p">);});</span>
</code></pre></div></div>

<p>Now, create HTTP POST route method to handle the command:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">/</span><span class="dl">'</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
  <span class="c1">// implement your bot here ...</span>
<span class="p">});</span>
</code></pre></div></div>

<p>Here, you need to look for the value of <code class="language-plaintext highlighter-rouge">text</code>, which comes from a user. To create a HTTP Status bot, the query should be something like “404” for <code class="language-plaintext highlighter-rouge">/httpstatus</code> command. You should write some error-checking code to see if you’re getting a right value. If a user enter a wrong value, throw some error or send a message, for example, look only for a digit:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="sr">/^</span><span class="se">\d</span><span class="sr">+$/</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// not a digit</span>
  <span class="nx">res</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="dl">'</span><span class="s1">U R DOIN IT WRONG. Enter a status code like 200!</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This message is sent privately to the user who entered a command with an unexpected value.</p>

<p>If the value is what you expect, send a response in JSON:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">response_type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">in_channel</span><span class="dl">'</span><span class="p">,</span> <span class="c1">// public to the channel</span>
  <span class="na">text</span><span class="p">:</span> <span class="dl">'</span><span class="s1">302: Found</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">attachments</span><span class="p">:[</span>
    <span class="p">{</span>
      <span class="na">image_url</span><span class="p">:</span> <span class="dl">'</span><span class="s1">https://http.cat/302.jpg</span><span class="dl">'</span>
    <span class="p">}</span>
<span class="p">]};</span>
<span class="nx">res</span><span class="p">.</span><span class="nf">json</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</code></pre></div></div>

<p>The answer to the correct command from the user will be displayed publicly by setting <code class="language-plaintext highlighter-rouge">response_type</code> as <code class="language-plaintext highlighter-rouge">in_channel</code> (The default type is <code class="language-plaintext highlighter-rouge">ephemeral</code>, sent as a private message).</p>

<p>This response will look like this on Slack:</p>

<p><img src="/assets/images/articles/2016/10/slack-command.png" alt="Slack command public message" /></p>

<p>In this example, I am using two parts in the response; (1) <code class="language-plaintext highlighter-rouge">text</code> and (2) <code class="language-plaintext highlighter-rouge">attachments</code>, which is an additional field displayed within the gray border, where I include an image.</p>

<p>Of course you can display text and change the border color in the attachment if you want. To customize the message format, see <a href="https://api.slack.com/docs/message-formatting">Basic message formatting</a> on Slack API docs.</p>

<p>Please note that in this code sample above, I hard-code the text and image URL, but in <a href="https://github.com/girliemac/slack-httpstatuscats">my actual code</a>, I keep all text strings in a separated file, and look it up if the user query matches. If not, display an error message privately.</p>

<p><img src="/assets/images/articles/2016/10/slack-command-private.png" alt="Slack command private message" /></p>

<p>Now, run the node code, then test your command on Slack client!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node index.js
</code></pre></div></div>

<p>If everything works fine on your private Slack chat, and you are happy as if, you’re done with the custom integration!</p>

<p>In the next step, you will handle the authentication and deploy the code. So if you want to distribute your command bot, read on!</p>

<h2 id="2-distributing-your-slack-bot">2. Distributing your Slack Bot</h2>

<p>To share your custom integration, you need to deploy the code and make it installable. To do so, you need to work on a few more things.</p>

<h3 id="setting-up-your-app">Setting up Your App</h3>

<p>Now you need to register for your app and get your API keys.</p>

<p>First, go to <a href="https://api.slack.com/apps">https://api.slack.com/apps</a>, and click the <strong>Create an App</strong> button.</p>

<p><img src="/assets/images/articles/2016/10/slack-create-app.png" alt="Slack Create App" /></p>

<p>You can fill out the rest of the form later. The App config may be a bit confusing because there are multiple parts (and you may not even notice everything first). For a slash command bot, you need to fill out at least these sections:</p>

<ul>
  <li>Basic Information (at https://api.slack.com/apps/YOUR_APP_ID/general)</li>
  <li>OAuth &amp; Permissions (at …/YOUR_APP_ID/oauth)</li>
  <li>Slash Commands (at …/YOUR_APP_ID/slash-commands)</li>
</ul>

<h4 id="keeping-your-credentials-in-env-file">Keeping Your Credentials in .env File</h4>

<p>Create <strong>.env</strong> file in the root of your app directory to keep your credentials (<strong>Client ID</strong>, <strong>Client secret</strong>, and <strong>Verification token</strong>) you can find at your app’s Basic Information section.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">SLACK_CLIENT_ID</span><span class="o">=</span>12345XXXXX.09876XXXXX
<span class="nv">SLACK_CLIENT_SECRET</span><span class="o">=</span>535d2f9....
<span class="nv">SLACK_VERIFICATION_TOKEN</span><span class="o">=</span>42P829U...
</code></pre></div></div>

<p>List the .env in your <strong>.gitignore</strong> file to keep out from public eyes when you push to git etc.</p>

<h4 id="using-foreman">Using Foreman</h4>

<p>To read the .env file from your app, I am using <a href="[https://coderwall.com/p/qdluuq/node-js-node-foreman](https://coderwall.com/p/qdluuq/node-js-node-foreman)">Node Foreman</a> (instead of <em>dotenv</em> module because it failed when deploying to Heroku).</p>

<p>You need to install it globally on your machine:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install</span> <span class="nt">-g</span> foreman
</code></pre></div></div>

<p>At the root of your app, create a file with name of <code class="language-plaintext highlighter-rouge">Procfile</code> and add this in the file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">web</span><span class="p">:</span> <span class="nx">node</span> <span class="nx">index</span><span class="p">.</span><span class="nx">js</span>
</code></pre></div></div>

<p>When you run our node app, run with</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nf start
</code></pre></div></div>

<h3 id="authenticating-a-user">Authenticating a User</h3>

<p>Slack uses <a href="https://oauth.net/2/">OAuth 2.0</a> for a user authentication. You can read the <a href="https://api.slack.com/docs/oauth">grant flow</a> on the Slack doc, but you actually don’t need to implement the whole OAuth mechanism in your app when you use the <a href="https://api.slack.com/docs/slack-button">Slack Button</a> to authenticate your users. The diagram shows below shows what you need to do, and I took this from the Slack API doc and modified:</p>

<p><img src="/assets/images/articles/2016/10/slack-oauth.gif" alt="OAuth with Slack" /></p>

<p>Basically, what you are going to do are:</p>

<ol>
  <li>Set up a web page with the button that passes some params to Slack. <em>(User: After clicking the button, Slack redirects the user to authenticate)</em>.</li>
  <li>Your node app will receive a temporary <code class="language-plaintext highlighter-rouge">code</code> from Slack via <code class="language-plaintext highlighter-rouge">GET</code>. The temp code expires in 10 min.</li>
  <li>Exchange the authorization code for an access token using the <a href="https://api.slack.com/methods/oauth.access"><code class="language-plaintext highlighter-rouge">oauth.access</code></a> API by <code class="language-plaintext highlighter-rouge">POST</code>ing. The auth process is done when your node app receives 200 OK. </li>
  <li>Optionally, use the <code class="language-plaintext highlighter-rouge">token</code> to call another API to get the team name, so that you can redirect the user to the team URL, https://team-name.slack.com right after the auth is done.</li>
</ol>

<p>When I was reading the Slack docs, I didn’t notice there was a button generator on Slack API page, so I started implementing by myself with Passport (Node.js OAuth middleware). But later I realized that  authentication with the button!</p>

<h4 id="setting-up-your-button">Setting up Your Button</h4>

<p>First, you need to set up a static web page. It can be a part of your node app, or separated. I made it independently from my node app, and host it on <a href="http://www.girliemac.com/slack-httpstatuscats/">GitHub Pages</a>.</p>

<p>Then go to <a href="https://api.slack.com/docs/slack-button">https://api.slack.com/docs/slack-button</a>, scroll to <strong>Add the Slack button</strong> to generate your button. Make sure to check <strong>Commands</strong> for the scope.</p>

<p><img src="/assets/images/articles/2016/10/slack-generate-button.png" alt="Slack button" /></p>

<p>If you want to do the optional API call to get the team info (step 4), you need to tweak the GET param in the auth URL.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"https://slack.com/oauth/authorize?scope=commands+team%3Aread&amp;client_id=your_client_id"</span><span class="nt">&gt;</span>
</code></pre></div></div>

<p>Notice the scope- along with <code class="language-plaintext highlighter-rouge">commands</code>, add <code class="language-plaintext highlighter-rouge">team:read</code> (Escape the <code class="language-plaintext highlighter-rouge">:</code> as <code class="language-plaintext highlighter-rouge">%3A</code>). You can learn more about <a href="https://api.slack.com/docs/oauth-scopes">OAuth scopes on the Slack API docs</a>.</p>

<p><img src="https://platform.slack-edge.com/img/add_to_slack.png" alt="Slack button" /></p>

<h4 id="issuing-token">Issuing Token</h4>

<p>Let’s use Express.js again to GET the temporary code (<code class="language-plaintext highlighter-rouge">req.query.code</code>) from Slack.</p>

<p>I am using <code class="language-plaintext highlighter-rouge">/slack</code> route. You can name whatever you want but make sure that you use the URL (Use your grok URL such as <em>http://71f03962.ngrok.io/slack</em> during development) as a <em>Redirect URL</em> at <strong>OAuth &amp; Permissions</strong> at https://api.slack.com/apps/YOUR_APP_ID/oauth as a part of your App configuration.</p>

<p>Once you get the temp code, you need to POST the code along with your credentials to exchange the code for an access token.</p>

<p>To POST, I am using <code class="language-plaintext highlighter-rouge">request</code>, a HTTP request client for Node.js.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>request <span class="nt">--save</span>
</code></pre></div></div>

<p>Once installed, get the temp code via GET (from a user auth) for a token via POST using <code class="language-plaintext highlighter-rouge">auth.access</code> API:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">request</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">/slack</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span><span class="na">form</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">client_id</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_ID</span><span class="p">,</span>
      <span class="na">client_secret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SLACK_CLIENT_SECRET</span><span class="p">,</span>
      <span class="na">code</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">code</span>
  <span class="p">}};</span>
  <span class="nx">request</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://slack.com/api/oauth.access</span><span class="dl">'</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nf">function </span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// You are done.</span>
      <span class="c1">// If you want to get team info, you need to get the token here</span>
      <span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">).</span><span class="nx">access_token</span><span class="p">;</span> <span class="c1">// Auth token</span>
    <span class="p">}</span>
  <span class="p">...</span>
</code></pre></div></div>

<h4 id="optional-redirecting-the-user-to-the-team-url">Optional: Redirecting the User to the Team URL</h4>

<p>Once the auth is done, you are done. However, I wanted to give a slightly better UX by redirecting the user to the chat room, instead of dumping the user right there like I’ve seen in many 3rd party Slack apps.</p>

<p>To obtain the team name (as a part of the chat room URL), use <a href="https://api.slack.com/methods/team.info"><code class="language-plaintext highlighter-rouge">team.info</code></a> API.</p>

<p>Add this where you got the access token in the code sample above:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
  <span class="nx">request</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="dl">'</span><span class="s1">https://slack.com/api/team.info</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span><span class="na">form</span><span class="p">:</span> <span class="p">{</span><span class="na">token</span><span class="p">:</span> <span class="nx">token</span><span class="p">}},</span>     <span class="nf">function </span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">team</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">).</span><span class="nx">team</span><span class="p">.</span><span class="nx">domain</span><span class="p">;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nf">redirect</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://</span><span class="dl">'</span> <span class="o">+</span><span class="nx">team</span><span class="o">+</span> <span class="dl">'</span><span class="s1">.slack.com</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
</code></pre></div></div>
<p>You need to use the access token to be able to access the API. Once successfully done, the API returns the user’s team info including the team name (<code class="language-plaintext highlighter-rouge">team.domain</code>), so use it to redirect the user to the team chat room URL.</p>

<p>Ta-da! Now your user should be re-directed to a right place!</p>

<p>For this article, I simplified all my code, but check out <a href="https://github.com/girliemac/slack-httpstatuscats">the entire code on GitHub</a> to see all the error handlings and when to use <em>Verification token</em> for your app.</p>

<h3 id="deploying-to-server">Deploying to Server</h3>

<p>Of course, you can deploy wherever you want. But if you want to deploy to Heroku like I did, I found <a href="https://blog.heroku.com/how-to-deploy-your-slack-bots-to-heroku">this article by Heroku</a> helpful.</p>

<p>Make sure to set up your env vars (where you set in your .env file) with the <code class="language-plaintext highlighter-rouge">heroku config</code> command such as <code class="language-plaintext highlighter-rouge">heroku config:set API_KEY=123</code></p>

<p>Once you are done with the deployment, go back to your Slack App setting page to change the <strong>OAuth &amp; Permission</strong> URL from your ngrok URL to the Heroku URL.</p>

<p>As you see, writing a Slack slash command itself is easy, but to figuring out the whole process to make the bot available to everybody was a bit pain for me. I spent most of my time reading the docs to just figuring out, and spend far less for coding.</p>

<p>So I hope my writing was helpful for you.</p>

<p><img src="/assets/images/articles/2016/10/slack-worked.png" alt="Hurray" /></p>

      <hr>

      <!-- Pagination -->
      <ul class="pagination">
	      
	        <li class="prev"><a href="/blog/2016/08/16/developer-experience-matters/" rel="prev">&larr; Developer Experience Matters</a></li>
	      
	      
	        <li class="next"><a href="/blog/2017/01/06/facebook-apiai-bot-nodejs/" rel="next">Creating a Simple Facebook Messenger AI Bot with API.ai in Node.js &rarr;</a></li>
	      
	  </ul>

      <hr style="visibility:hidden;">

      <!-- Categories -->
      
	  <ul class="categories">
	      <li><i class="icon-drawer"></i></li>
	      

	      
		    
		    	<li data-size="15"><a href="/categories/#dev">
		    		dev
		    	</a></li>
		    
		    	<li data-size="2"><a href="/categories/#bot">
		    		bot
		    	</a></li>
		    
		    	<li data-size="1"><a href="/categories/#slack">
		    		slack
		    	</a></li>
		    
		    	<li data-size="10"><a href="/categories/#javascript">
		    		javascript
		    	</a></li>
		    
		    	<li data-size="8"><a href="/categories/#node.js">
		    		node.js
		    	</a></li>
		    
		    	<li data-size="4"><a href="/categories/#cats">
		    		cats
		    	</a></li>
		    
		    	<li data-size="1"><a href="/categories/#oauth">
		    		oauth
		    	</a></li>
		    
		  
	      

	  </ul>
	  

	  <!-- Disqus -->
	      <div id="disqus_thread" style="margin-top: 3em"></div>
		    <script type="text/javascript">
		        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		        var disqus_shortname = 'laoazhang'; // required: replace example with your forum shortname
				

		        /* * * DON'T EDIT BELOW THIS LINE * * */
		        (function() {
		            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		        })();
		    </script>
		    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">

    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#main -->

<footer>
  <small class="copyright">
    <span>&copy; 2024 laoazhang. Powered by <a href="http://jekyllrb.com">Jekyll</a> with modified <em>Minimal Mistakes</em> theme. Hosted on <a href="http://github.com">Github</a>.
  </small>
</footer>

<script src="https://laoazhang.cn/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-2635445-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>

</script>

</body>
</html>
