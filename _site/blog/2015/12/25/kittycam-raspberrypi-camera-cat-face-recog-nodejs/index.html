<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>KittyCam - Building a Raspberry Pi Camera with Cat Face Detection in Node.js &#8211; Laoazhang! Blog</title>
<meta name="description" content="">
<meta name="keywords" content="">

<!-- Twitter cards -->
<meta name="twitter:site"    content="@laoazhang">
<meta name="twitter:creator" content="@laoazhang">



<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://laoazhang.cn//assets/images/articles/2015/12/jamie-detected.png">



<meta name="twitter:title"   content="KittyCam - Building a Raspberry Pi Camera with Cat Face Detection in Node.js">



<meta name="twitter:description" content="If you only do what you can do, you will never be more than you are now">


<!-- end of Twitter cards -->

<!-- Web Monetization | Interledger -->
<meta name="monetization" content="$ilp.uphold.com/6NxbkHNq9N84">
<meta name="monetization" content="$twitter.xrptipbot.com/laoazhang" />

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="KittyCam - Building a Raspberry Pi Camera with Cat Face Detection in Node.js">
<meta property="og:description" content="If you only do what you can do, you will never be more than you are now">
<meta property="og:url" content="https://laoazhang.cn/blog/2015/12/25/kittycam-raspberrypi-camera-cat-face-recog-nodejs/">
<meta property="og:site_name" content="Laoazhang! Blog">

<!-- Webmaster Tools verfication -->
<meta name="google-site-verification" content="I-NDFBl5t1P9fqHmRNZhwu8OOHmwW4HADPiOr_r16cE">



<link rel="canonical" href="https://laoazhang.cn/blog/2015/12/25/kittycam-raspberrypi-camera-cat-face-recog-nodejs/">
<link href="https://laoazhang.cn/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">


<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='//fonts.googleapis.com/css?family=Open+Sans:400italic,400,600,700' rel='stylesheet' type='text/css'>

<!-- For all browsers -->
<link rel="stylesheet" href="https://laoazhang.cn/assets/css/main.min.css">

<!--[if (lt IE 9) & (!IEMobile)]>
<link rel="stylesheet" href="https://laoazhang.cn/assets/css/ie.min.css">
<![endif]-->

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script src="https://laoazhang.cn/assets/js/vendor/modernizr/modernizr.js"></script>

<!-- Icons -->

<!-- favicon -->
<link rel="shortcut icon" href="https://laoazhang.cn/assets/ico/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://laoazhang.cn/assets/ico/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://laoazhang.cn/assets/ico/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://laoazhang.cn/assets/ico/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://laoazhang.cn/assets/ico/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="article" itemscope itemtype="https://schema.org/WebPage">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="https://laoazhang.cn/index.html">Laoazhang.cn</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" itemscope itemtype="https://schema.org/SiteNavigationElement">
		    <ul>
		        
				<li><a href="https://laoazhang.cn/about" >About</a></li>
		        
				<li><a href="https://laoazhang.cn/blog" >Archive</a></li>
		        
				<li><a href="https://laoazhang.cn/presentations" >Preso</a></li>
		        
				<li><a href="https://laoazhang.cn/doodles" >Sketch Notes</a></li>
		        
				<li><a href="https://codepen.io/laoazhang" target="_blank">My CodePen</a></li>
		        
		        <li><i class="icon-feed"></i> <a href="https://laoazhang.cn/feed.xml" title="Atom/RSS feed">Feed</a>
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->


<header role="banner">
</header>

<div id="main" role="main" itemprop="mainContentOfPage" itemscope itemtype="https://schema.org/Blog">
  <div class="article-author-side">
  	<img src="https://laoazhang.cn/assets/images/avatar.jpg" class="bio-photo" alt="laoazhang">
    <h3>laoazhang</h3>
<p class="bio">An Open Web advocate and front-end engineer, who loves everything mobile, and writes about HTML5, CSS, JS, UX, tech events, gadgets, etc. She unintentionally got 15min of fame by creating The HTTP Status Cats. Also, the opinions expressed here are solely her own and do not express the views or opinions of my employer.</p>
<a href="https://twitter.com/laoazhang" class="author-social" target="_blank"><i class="icon-twitter"></i> Twitter</a>
<a href="https://facebook.com/laoazhang" class="author-social" target="_blank"><i class="icon-facebook"></i> Facebook</a>

<a href="https://linkedin.com/in/laoazhang" class="author-social" target="_blank"><i class="icon-linkedin"></i> LinkedIn</a>
<a href="https://instagram.com/laoazhang" class="author-social" target="_blank"><i class="icon-instagram"></i> Instagram</a>
<a href="https://github.com/laoazhang" class="author-social" target="_blank"><i class="icon-github"></i> Github</a>




        <p class="license">
      
    </p>

  </div>

  <article itemscope itemtype="http://schema.org/BlogPosting" itemprop="blogPost">
    <div class="headline-wrap">
      
      <time datetime="2015-12-25T00:00:00-08:00" itemprop="datePublished"><i class="icon-calendar"></i> December 25, 2015</time>

      
      <h1 itemprop="name">KittyCam - Building a Raspberry Pi Camera with Cat Face Detection in Node.js</h1>
      <h2></h2>
    </div><!--/ .headline-wrap -->

    <div class="article-wrap" itemprop="text">
      <p><img src="https://lh3.googleusercontent.com/UuKlrNQWs5wFciRqI8qiZKTVoh4XrTBa40LD5mUa5MIn=w1346-h757-no" alt="RPi KittyCam" title="Rapsberry Pi KittyCam" /></p>

<p>Ho, ho, ho! This is an overdue blog post for <a href="https://github.com/girliemac/RPi-KittyCam">the project</a> I’ve worked on during summer!</p>

<p>Last August, I created this Raspberry Pi app using a camera and PIR motion sensor, written in Node.js with helps with <strong>Johnny-Five</strong> and <strong>KittyDar</strong>. As I promised on the README file of the GitHub repo, I am finally writing the detailed instruction of how I built hardware and wrote the app.</p>

<p><img src="/assets/images/articles/2015/12/youtube-kittycam-thumb.jpg" alt="KittyCam on YouTube" title="YouTube" />
<a href="https://www.youtube.com/watch?v=wqewhjhjaHY">Watch the demo on YouTube :-)</a></p>

<h2 id="how-kittycam-works">How KittyCam Works</h2>

<p>The software is written in Node.js, simply because JavaScript is the language I am most comfortable with, also it is fun!</p>

<p>This is the basic flow:</p>

<ol>
  <li>Detect motion (Use Johnny-Five IR.Motion obj)</li>
  <li>Take photos (Raspistill, command line tool)</li>
  <li>Cat facial detection (KittyDar)</li>
  <li>Store the photos in cloud storage (Cloudinary)</li>
  <li>Publish the data (URL) to PubNub for realtime streaming</li>
  <li>Stream on web (subscribe the data from PubNub)</li>
</ol>

<p><img src="/assets/images/articles/2015/12/kittyCam-app.png" alt="KittyCam flow" title="KittyCam flow" /></p>

<p>The hardware-software communication is done with <a href="http://johnny-five.io/">Johnny-Five</a>, open-source JavaScript robotics programming framework. I am using it to talk with a PIR sensor. When the sensor detect my cat (or any moving objects) nearby Raspberry Pi, it triggers the camera.</p>

<p>Photos are taken using <code class="language-plaintext highlighter-rouge">raspistill</code> command line. One cool thing about Node.js is that you can execute commands by spawning child processes.</p>

<p>Once a photo is taken, I am using another child process to detect if any cats are on the photo, using <a href="https://github.com/harthur/kittydar">KittyDar</a>, an open source face detection for cats, written by Heather Arthur.</p>

<p>Additionally, I am sending the photos (only photos with cats) to a cloud storage, and at the same time, I stream the photo to web browser using <a href="http://pubnub.com">PubNub</a>, because I work for the company!</p>

<p>Now, let’s build your own!</p>

<h2 id="building-the-circuit-with-raspberry-pi-2">Building the Circuit with Raspberry Pi 2</h2>

<h3 id="what-you-need">What you need</h3>

<p>First, you need to get some hardware along with Raspberry Pi 2. I don’t recommend any older Raspberry Pi, as their memory is too low to run some code.</p>

<p>The Pi needs to be pre-installed with <strong>Raspbian OS</strong>. And if you are starting from a scratch, with Raspberry Pi fresh out of box, you can take a look at <a href="https://github.com/pubnub/workshop-raspberrypi"><strong>Setting up Raspberry Pi</strong> section of the instruction I wrote for my workshop</a> I give at conferences sometimes.</p>

<p>But if you are a newbie, I recommend to buy your first Pi from <a href="http://www.amazon.com/gp/product/B008XVAVAW/ref=as_li_qf_sp_asin_il_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B008XVAVAW&amp;linkCode=as2&amp;tag=girliemac-20&amp;linkId=DU2AO5J5GTPAQMPO">CanaKit</a>, so you don’t need to set it up all by yourself.</p>

<p><img src="/assets/images/articles/2015/12/what-you-need-raspberry-pi.jpg" alt="What you need and how to assemble" title="The stuff you need and how to assemble" /></p>

<ol>
  <li>Raspberry Pi 2 (with WiFi adapter) (<a href="http://amzn.to/1rk3VZY">buy</a>)</li>
  <li>5MP Camera Board Module (<a href="http://amzn.to/1UKaEXl">buy</a>)</li>
  <li>Pyroelectric Infrared (PIR) motion sensor (<a href="http://amzn.to/1ZJ3Nir">buy</a>)</li>
  <li>3 Female/Female wires (<a href="http://amzn.to/1U8ajAZ">buy</a>)</li>
  <li>Optional: LEGO compatible SmartiPi w/ camera case (<a href="http://amzn.to/28vkhAR">buy</a>)</li>
</ol>

<h3 id="assembling-hardware">Assembling Hardware</h3>

<p>This doesn’t require much of wiring. You can connect a camera and a PIR sensor directory to a Pi without any breadboards or soldering, as you see in the photo above at the previous section, or this Fritzing diagram below.</p>

<p><img src="/assets/images/articles/2015/12/pi-pir-camera_bb.png" alt="RPi KittyCam" title="Assemble PIR and camera" /></p>

<h4 id="camera-to-pi">Camera to Pi</h4>
<ul>
  <li>Connect the camera module to the CSI port. See <a href="https://www.raspberrypi.org/help/camera-module-setup/">the video instruction of how to set up th camera module on RaspberryPi.org</a>.</li>
</ul>

<h4 id="pir-sensor-to-pi">PIR Sensor to Pi</h4>
<ul>
  <li>1 red wire: PIR-VCC to Pi’s <strong>5V</strong> pin</li>
  <li>1 black wire: PIR-GND to Pi’s ground (<strong>GND</strong> pin)</li>
  <li>1 whatever color wire (brown in the photo): PIR-OUT to Pi’s Pin <strong>7</strong> (GPIO 4)</li>
</ul>

<p>The photo below is my Pi enclosed in SmartiPi case:
<img src="https://lh3.googleusercontent.com/o-XG7ZijXM_UXQHuYrDxC6mlTofyUzUCmHqNmr6oRYZk=w1346-h757-no" alt="RPi KittyCam" title="Rapsberry Pi KittyCam" /></p>

<h2 id="working-remotely-from-mac">Working Remotely from Mac</h2>

<p>You can plug in a monitor, keyboard, mouse, etc to your Pi and work directly on Raspbian GUI, or work from you Mac, like I usually do. This is how I work remotely on Mac:</p>

<h3 id="ssh-ing-into-raspberry-pi">SSH-ing into Raspberry Pi</h3>

<p>First, make sure your Pi and computer are on the same WiFi network.</p>

<p>If you are directly connecting your Pi to a monitor and a keyboard, open a terminal, and find the IP address:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pi@raspberrypi ~<span class="nv">$ </span><span class="nb">hostname</span> <span class="nt">-I</span>
</code></pre></div></div>

<p>Or use some IP scanner app on Mac, like <a href="http://angryip.org/download/#mac">Angry IP Scanner</a> to scan all connected devices.</p>

<p>Once you find the IP address, open a terminal app on Mac, and ssh into the address. I am using the default username for Pi, “pi”.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tomomi@Mac ~<span class="nv">$ </span>ssh pi@10.0.1.13
</code></pre></div></div>

<p>Then type the password. Default is “raspberry”.</p>

<p>Once connected to your Pi, you can create files, code, and execute from the terminal. Raspbian is a Debian based, so you can use usual linux commands.</p>

<h3 id="coding-on-your-fave-ide-on-mac">Coding on Your Fave IDE on Mac</h3>

<p>I usually use <strong>Sublime Text</strong> to code, so I prefer doing so for coding on Pi as well.
Here’s what I do:</p>

<p>First, download and install <a href="https://cyberduck.io">Cyberduck</a> on Mac.</p>

<p>Then connect your Pi via SSH, using its IP address (See the screenshot below)
<img src="/assets/images/articles/2015/12/cyberduck-connect-rpi.png" alt="Cyberduck to RPi" title="Connect Rapsberry Pi via Cyberduck" /></p>

<p>When you edit a file, open the file with “Edit”.
<img src="/assets/images/articles/2015/12/cyberduck-connect-rpi-edit.png" alt="Cyberduck to RPi" title="Connect Rapsberry Pi via Cyberduck" /></p>

<p>In my case, it automatically select Sublime to edit JavaScript files.</p>

<h2 id="software-setup">Software Setup</h2>

<h3 id="1-install-nodejs-in-your-raspberry-pi">1. Install node.js in your Raspberry Pi</h3>

<p>Make sure your Pi is up-to-date!</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get update
</code></pre></div></div>

<p>then</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get upgrade
</code></pre></div></div>

<h4 id="download-and-install">Download and Install</h4>

<p>Let’s download node from <a href="http://node-arm.herokuapp.com/">node-arm</a>, which is probably the easiest way:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>wget http://node-arm.herokuapp.com/node_archive_armhf.deb
</code></pre></div></div>

<p>and install the package:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>dpkg <span class="nt">-i</span> node_archive_armhf.deb
</code></pre></div></div>

<p>Check if node is successfully installed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node <span class="nt">-v</span>
</code></pre></div></div>
<p>As of Dec. 2015, the archive should install Node v0.12.6. This is the version I used and works fine for sure.</p>

<h3 id="2-enable-camera-access">2. Enable Camera Access</h3>

<p>To be able to use a hardware camera module with your Pi, you need to enable the software first.</p>

<p>Go to <strong>Pi Software Config Tool</strong> menu from a terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>raspi-config
</code></pre></div></div>

<p>You should see the menu like this. Use arrow keys to select <strong>Enable Camera</strong>.</p>

<p><img src="/assets/images/articles/2015/12/config-enable-pi-camera.png" alt="Pi Software Config Tool" title="Pi Software Config Tool" /></p>

<p>Hit Return, then at the next screen, select <strong>Enable</strong>.</p>

<p>Test if your camera is working by try typing this command on terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>raspistill <span class="nt">-o</span> photo.jpg
</code></pre></div></div>

<h2 id="installing-dependencies">Installing Dependencies</h2>

<p>If you wish to run the code from my GitHub repo, clone <a href="https://github.com/girliemac/RPi-KittyCam">RPi-KittyCam repo on GitHub</a>, and copy them over on Raspberry Pi.</p>

<p>It would be really nice if <code class="language-plaintext highlighter-rouge">$ npm install</code> successfully install all the dependencies, and voilà, but it does <strong>not</strong> work in that way, unfortunately. You still need to set up and install dependencies manually.</p>

<h3 id="1-prerequisite-install-cairo-to-the-system">1. Prerequisite: Install Cairo to the System</h3>

<p>for cat facial detection, I am using <strong>kittydar</strong>, which dependencies including <strong>node-canvas</strong>, which requires <strong>Cairo</strong>.</p>

<p>So let’s get Cairo on your Raspbian first.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>libcairo2-dev libjpeg8-dev libpango1.0-dev libgif-dev build-essential g++
</code></pre></div></div>

<p>See more info on how to install Cairo for Node <a href="https://github.com/Automattic/node-canvas">Canvas</a>, see this <a href="https://github.com/Automattic/node-canvas/wiki/Installation---Ubuntu-and-other-Debian-based-systems"><em>Installation Ubuntu and other Debian based systems</em></a></p>

<p>If you download the <code class="language-plaintext highlighter-rouge">node_modules</code> contents of my GitHub repo, skip the step 2, and proceed to step 3.
Otherwise, go to the next step to manually fresh-install the next several modules. Just running <code class="language-plaintext highlighter-rouge">npm install</code> to fetch all dependencies may fail because there is some incompatibilities. (I explain it later).</p>

<h3 id="2-install-dependency-modules">2. Install Dependency Modules</h3>

<p>Now, <code class="language-plaintext highlighter-rouge">cd</code> to your working directry, and install dependencies.</p>

<h4 id="install-canvas">Install Canvas</h4>

<p>You need canvas (<strong>node-canvas</strong>) to be able to analyze images with KittyDar.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>npm <span class="nb">install </span>canvas
</code></pre></div></div>

<h4 id="install-kittydar">Install KittyDar</h4>

<p><strong>Kittydar</strong> is an open-source cat face detection. It takes an image (canvas) and tells you the if cats are in the image.</p>

<p><img src="http://res.cloudinary.com/girliemac/image/upload/v1440530252/jrfqcdul46c84qlqlks9.png" alt="Jamie detected" title="Jamie detected by KittyDar" /></p>

<p><em>This is an actual photo taken by my Raspberry Pi, while Jamie was eating, and detected by KittyDar cat facial detection!</em></p>

<p>Once your environment is set up, in this RPi-KittyCam dir, install node dependency modules.</p>

<p>Ideally install from <code class="language-plaintext highlighter-rouge">npm install kittydar —save</code></p>

<p>However, node-canvas 1.0.1 (the version specified in package.json for KittyDar) failed to build with the current Node.js (v0.12.6).</p>

<p>So what I did was download the zip from github repo into <em>node_modules</em>, alter the <code class="language-plaintext highlighter-rouge">package.json</code>, where canvas: ~1.0.1 to ^1.0.1 so that the latest canvas is installed as I <code class="language-plaintext highlighter-rouge">npm install</code> from the kittydar directory.</p>

<p>Get the zip from <a href="https://github.com/girliemac/kittydar">my forked repo</a>.</p>

<p><em>Note: Although, the repo is no longer maintained by the author, I am sending <a href="https://github.com/harthur/kittydar/pull/27]">a pull request</a> for the fix.</em></p>

<h4 id="install-johnny-five">Install Johnny-Five</h4>

<p><strong>Johnny-Five</strong> is a JavaScript Robotics programming framework. It makes communicating with hardware so much easier.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>johnny-five
</code></pre></div></div>

<h4 id="install-raspi-io">Install Raspi-io</h4>

<p><strong>Raspi-io</strong> is a library to be used as an I/O plugin with Johnny-Five. You need to install this to use Johnny-Five on Raspbian.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>raspi-io
</code></pre></div></div>

<h3 id="3-install-3rd-party-service-modules">3. Install 3rd Party Service Modules</h3>

<p>This step is optional, if you don’t want to create a web interface to stream the photos, or you would rather create your own web server without depending on the 3rd party services.</p>

<h4 id="install-pubnub">Install PubNub</h4>

<p>For realtime live-updating the web interface, I am using PubNub.
To use the service, you need to <a href="http://pubnub.com">sign up</a> to obtain your API keys.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>pubnub
</code></pre></div></div>

<h4 id="install-cloudinary">Install Cloudinary</h4>

<p>For storing photos, use Cloudinary.
To use the service, you need to <a href="http://cloudinary.com/">sign up</a> to obtain your API keys.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>npm <span class="nb">install </span>cloudinary
</code></pre></div></div>

<h4 id="set-up-your-configjs-with-credentials">Set up your config.js with Credentials</h4>

<p>Create a <code class="language-plaintext highlighter-rouge">config.js</code> in the root dir of the app.
The file should include your API keys:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>

  <span class="na">cloudinary</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">cloud_name</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_name</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">api_key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_API_key</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">api_secret</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_API_secret</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">},</span>

  <span class="na">pubnub</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">subscribe_key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_sub_key</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">publish_key</span><span class="p">:</span> <span class="dl">'</span><span class="s1">your_pub_key</span><span class="dl">'</span>
  <span class="p">}</span>

<span class="p">};</span>
</code></pre></div></div>

<h3 id="4-run-the-code">4. Run the Code</h3>

<p>Once you have configured everything and have all source files from my GitHub repo, try running kittyCam.js.</p>

<p>You must run with sudo:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>node kittyCam.js
</code></pre></div></div>

<p>The camera will take a photo when a motion is detected by the PIR sensor.
Then the <code class="language-plaintext highlighter-rouge">child_process</code> runs to detect if there is any cats in the photo.
When there are any cat, it sends the photo to Cloudinary.</p>

<p>Analyzed photos are deleted from the filesystem to clear up Pi.</p>

<h3 id="5-view-the-live-photo-update-on-web">5. View the Live Photo Update on Web</h3>

<ul>
  <li>Get the web interface source code from <code class="language-plaintext highlighter-rouge">gh-pages</code> branch.</li>
  <li>Run the <code class="language-plaintext highlighter-rouge">index.html</code> on browser</li>
</ul>

<p><img src="https://raw.githubusercontent.com/girliemac/RPi-KittyCam/gh-pages/images/screenshot.png" alt="Jamie detected" title="KittyCam Web" /></p>

<h2 id="walking-through-the-code">Walking Through the Code</h2>

<p>Although I am not writing a full tutorial how to write this Node app from scratch, I can explain some of the key features.</p>

<h3 id="detecting-motion-from-a-pir-sensor">Detecting Motion from a PIR Sensor</h3>

<p>I am using Johnny-Five’s <code class="language-plaintext highlighter-rouge">IR.Motion</code> object to detect the motion.</p>

<p>First, include the dependencies.</p>

<p>Then, create a new <code class="language-plaintext highlighter-rouge">motion</code> hardware instance at pin 7, and when a motion is detected, take a photo:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">raspi</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">raspi-io</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">five</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">johnny-five</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">board</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">five</span><span class="p">.</span><span class="nc">Board</span><span class="p">({</span><span class="na">io</span><span class="p">:</span> <span class="k">new</span> <span class="nf">raspi</span><span class="p">()});</span>

<span class="nx">board</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">ready</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">motion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">five</span><span class="p">.</span><span class="nc">Motion</span><span class="p">(</span><span class="dl">'</span><span class="s1">P1-7</span><span class="dl">'</span><span class="p">);</span>

  <span class="nx">motion</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">motionstart</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Run raspistill command to take a photo with the camera module  </span>
	<span class="c1">// then detect cats from the photo</span>
  <span class="p">})</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="execute-command-with-child-process">Execute Command with Child Process</h3>

<p>In the code snippet above, where the first comment is, run <code class="language-plaintext highlighter-rouge">raspistill</code> command using <code class="language-plaintext highlighter-rouge">child_process.spawn()</code> to take a photo with the camera module:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">filename</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">photo/image_</span><span class="dl">'</span><span class="o">+</span><span class="nx">i</span><span class="o">+</span><span class="dl">'</span><span class="s1">.jpg</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">-w</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">320</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-h</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">240</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-o</span><span class="dl">'</span><span class="p">,</span> <span class="nx">filename</span><span class="p">,</span> <span class="dl">'</span><span class="s1">-t</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">1</span><span class="dl">'</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">child_process</span><span class="p">.</span><span class="nf">spawn</span><span class="p">(</span><span class="dl">'</span><span class="s1">raspistill</span><span class="dl">'</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>

<span class="nx">spawn</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">exit</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">A photo is saved as </span><span class="dl">'</span><span class="o">+</span><span class="nx">filename</span><span class="o">+</span> <span class="dl">'</span><span class="s1"> with exit code, </span><span class="dl">'</span> <span class="o">+</span> <span class="nx">code</span><span class="p">);</span>
  <span class="nx">i</span><span class="o">++</span><span class="p">;</span>

  <span class="c1">// Detect cats from photos - see the next section</span>
  <span class="p">...</span>
</code></pre></div></div>

<p>Here, I am saving photos in sequential orders.</p>

<h3 id="detect-cat-with-kittydar">Detect Cat with KittyDar</h3>

<p>To be able to keep taking photos without interruptions, as each photo is being processed, I am using another <code class="language-plaintext highlighter-rouge">child_process</code>, this time with <code class="language-plaintext highlighter-rouge">fork()</code>, an instance of spawn thats runs a new instance of the V8 engine to create multiple wrokers.</p>

<p>After the comment in the code snippet above, read another JS file:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">imgPath</span> <span class="o">=</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">filename</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="nx">imgPath</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">fork</span> <span class="o">=</span> <span class="nx">child_process</span><span class="p">.</span><span class="nf">fork</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="dl">'</span><span class="s1">/detectCatsFromPhoto.js</span><span class="dl">'</span><span class="p">);</span>
<span class="nx">fork</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">args</span><span class="p">);</span>

<span class="c1">// the child process is completed</span>
<span class="nx">fork</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nx">base64</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// send the image to the cloud storage</span>
  <span class="p">}</span>
  <span class="nf">deletePhoto</span><span class="p">(</span><span class="nx">imgPath</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div></div>

<p>In <strong>detectCatsFromPhoto.js</strong>, start the child process and use canvas and kittydar to detect cats. Once the process is done, the image is returned in Base64:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">kittydar</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">kittydar</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Canvas</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">kittydar/node_modules/canvas</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">process</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">message</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">imgPath</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nf">readFile</span><span class="p">(</span><span class="nx">imgPath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Canvas</span><span class="p">.</span><span class="nx">Image</span><span class="p">;</span>
    <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

    <span class="c1">//... snip snip, some canvas setup code here...</span>

    <span class="kd">var</span> <span class="nx">cats</span> <span class="o">=</span> <span class="nx">kittydar</span><span class="p">.</span><span class="nf">detectCats</span><span class="p">(</span><span class="nx">canvas</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">base64Img</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">cats</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">base64Img</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nf">toDataURL</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="nx">process</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nx">base64Img</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To see the entire source code, please take a look at <a href="https://github.com/girliemac/RPi-KittyCam">my GitHub repo</a>!</p>

<p>Also to see how I used PubNub to stream the live photos on web browser, look at the source code on the <a href="https://github.com/girliemac/RPi-KittyCam/tree/gh-pages">gh-pages branch</a>.</p>

<h2 id="known-issues">Known Issues</h2>

<h3 id="raspistill-camera-software">Raspistill (Camera Software)</h3>

<ul>
  <li>Raspistill continuously takes a bunch of photos when I set <code class="language-plaintext highlighter-rouge">t = 0</code> (and crashes Pi while so many child process is running) so I have set <code class="language-plaintext highlighter-rouge">t = 1</code>, which causes delay. It seems to take only integer. Cats are too fast to wait for a second.</li>
  <li>The camera can’t capture recognizable pics after the sun is set. The room light is too dark.</li>
</ul>

<h3 id="kittydar-cat-facial-recognition">KittyDar (Cat Facial Recognition)</h3>

<ul>
  <li>During his meal time, when Jamie (my cat) is eating food in his head-down position, the facial detection fails to recognize the cat face shape.</li>
  <li>When my cat moves, eats from the side of the dish, or put his butt on the camera, it fails to tell me my cat was eating.</li>
</ul>

<h4 id="the-cat-photos-failed-to-be-recognized">The cat photos failed to be recognized</h4>

<p><img src="https://raw.githubusercontent.com/girliemac/RPi-KittyCam/master/photo/image_14.jpg" alt="Jamie undetected" title="Jamie undetected" />
<img src="https://raw.githubusercontent.com/girliemac/RPi-KittyCam/master/photo/image_150.jpg" alt="Jamie undetected" title="Jamie undetected" />
<img src="https://raw.githubusercontent.com/girliemac/RPi-KittyCam/master/photo/image_166.jpg" alt="Jamie undetected" title="Jamie undetected" />
<img src="https://raw.githubusercontent.com/girliemac/RPi-KittyCam/master/photo/image_311.jpg" alt="Upside-down Jamie undetected" title="Jamie undetected" /></p>

<h2 id="omg-i-demod-kittycam-on-live-tv-show">OMG, I demo’d KittyCam on Live TV Show!</h2>

<p>See my <a href="http://www.girliemac.com/blog/2015/09/14/the-screen-savers-show/">last blog post</a> about my experience being on Twit TV! You can watch the segment on the <a href="https://twit.tv/shows/new-screen-savers/episodes/19?autostart=false">recorded show</a> too.</p>

<p>OK, I hope you enjoyed my lengthy blog post!</p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://www.raspberrypi.org/">Raspberry Pi</a>: Teach, Learn, and Make with Raspberry Pi</li>
  <li><a href="https://github.com/nathanjohnson320/node_arm">Node ARM</a>: Install node.js on a raspberry pi in two easy steps</li>
  <li><a href="http://johnny-five.io/">Johnny-Five</a>: The original JavaScript Robotics programming framework</li>
  <li><a href="https://github.com/nebrius/raspi-io">Raspi-IO</a>: An IO plugin for Johnny-Five that provides support for the Raspberry Pi</li>
  <li><a href="https://github.com/harthur/kittydar">KittyDar</a>: Face detection for cats in JavaScript</li>
  <li><a href="https://github.com/Automattic/node-canvas">Node Canvas</a>: A Cairo backed Canvas implementation for NodeJS</li>
  <li><a href="https://www.pubnub.com/">PubNub</a>: The global realtime Data Stream Network for IoT, mobile, and web applications</li>
</ul>

      <hr>

      <!-- Pagination -->
      <ul class="pagination">
	      
	        <li class="prev"><a href="/blog/2015/09/14/the-screen-savers-show/" rel="prev">&larr; Hey, I am on The New Screen Savers Show!</a></li>
	      
	      
	        <li class="next"><a href="/blog/2016/06/13/kittycam-update-with-raspberrypi3/" rel="next">Upgrading KittyCam with Raspberry Pi 3 &rarr;</a></li>
	      
	  </ul>

      <hr style="visibility:hidden;">

      <!-- Categories -->
      
	  <ul class="categories">
	      <li><i class="icon-drawer"></i></li>
	      

	      
		    
		    	<li data-size="15"><a href="/categories/#dev">
		    		dev
		    	</a></li>
		    
		    	<li data-size="3"><a href="/categories/#raspberrypi">
		    		raspberrypi
		    	</a></li>
		    
		    	<li data-size="5"><a href="/categories/#pubnub">
		    		pubnub
		    	</a></li>
		    
		    	<li data-size="10"><a href="/categories/#javascript">
		    		javascript
		    	</a></li>
		    
		    	<li data-size="8"><a href="/categories/#node.js">
		    		node.js
		    	</a></li>
		    
		    	<li data-size="4"><a href="/categories/#cats">
		    		cats
		    	</a></li>
		    
		  
	      

	  </ul>
	  

	  <!-- Disqus -->
	      <div id="disqus_thread" style="margin-top: 3em"></div>
		    <script type="text/javascript">
		        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		        var disqus_shortname = 'laoazhang'; // required: replace example with your forum shortname
				

		        /* * * DON'T EDIT BELOW THIS LINE * * */
		        (function() {
		            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
		            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
		            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		        })();
		    </script>
		    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
		    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">

    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#main -->

<footer>
  <small class="copyright">
    <span>&copy; 2024 laoazhang. Powered by <a href="http://jekyllrb.com">Jekyll</a> with modified <em>Minimal Mistakes</em> theme. Hosted on <a href="http://github.com">Github</a>.
  </small>
</footer>

<script src="https://laoazhang.cn/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl = 
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-2635445-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


<script>

</script>

</body>
</html>
